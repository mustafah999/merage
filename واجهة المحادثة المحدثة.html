<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>واجهة محادثة صوتية محسنة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Rakkas&amp;family=Tajawal:wght@300;400;500;700&amp;family=Inter:wght@300;400;500;600;700;900&amp;display=swap" rel="stylesheet"/>
    <style>
        :root {
            --brand-color: #0279d7;
            --button-text-color: #ffffff;
            --input-bg: #ffffff;
            --input-text: #1f2937;
            --input-placeholder: #9ca3af;
            --input-border: #d1d5db;
            --chat-bubble-user-bg: #0279d7;
            --chat-bubble-user-text: #ffffff;
            --chat-bubble-ai-bg: #e5e7eb;
            --chat-bubble-ai-text: #1f2937;
            --card-bg: rgba(255, 255, 255, 0.3);
            --text-color: #1a202c;
            --header-stroke-color: #374151;
        }

        html { height: 100%; }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #000;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
            margin: 0; padding: 0;
            position: relative;
        }
        .font-rakkas { font-family: 'Rakkas', cursive; }
        .font-inter { font-family: 'Inter', sans-serif; }

        .bg-video-element { position: fixed; top: 0; left: 0; min-width: 100%; min-height: 100%; width: auto; height: auto; z-index: -2; object-fit: cover; opacity: 0; transition: opacity 0.6s ease; }
        .bg-video-element.video-visible { opacity: 1; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.25); z-index: -1; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(128, 128, 128, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.4); border-radius: 10px; }
        
        #app-view-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; width: 100%; }
        #main-header { width: 100%; max-width: 48rem; margin: 0 auto; padding: 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 20; flex-shrink: 0; position: sticky; top: 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding-top: calc(var(--safe-area-top, 0px) + 0.5rem); padding-bottom: 0.5rem; background-color: var(--card-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        html[dir="rtl"] #main-header { flex-direction: row-reverse; }
        #main-title-wrapper { flex-grow: 1; text-align: center; transform: translateY(9px); }
        .title-container h1 { font-size: 1.625rem; text-shadow: none; -webkit-text-stroke: 5px var(--header-stroke-color); text-stroke: 5px var(--header-stroke-color); color: var(--brand-color); paint-order: stroke fill; }
        .header-icon { color: var(--header-stroke-color) !important; padding: 0.5rem; border-radius: 9999px; background: transparent; border: none; cursor: pointer;}

        #chat-view { flex-grow: 1; display: flex; flex-direction: column; width: 100%; max-width: 48rem; margin: 0 auto; padding: 0; overflow: hidden; z-index: 10; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; }
        #chat-messages::-webkit-scrollbar-thumb { background: var(--brand-color); }

        .message-container { display: flex; flex-direction: column; gap: 0.25rem; max-width: 80%; }
        .message-container.self-end { align-self: flex-end; align-items: flex-end; }
        .message-container.self-start { align-self: flex-start; align-items: flex-start; }
        
        .chat-bubble { padding: 0.875rem 1.25rem; border-radius: 1.25rem; max-width: 100%; word-wrap: break-word; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); box-shadow: 0 3px 6px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.1); line-height: 1.6; white-space: pre-wrap; }
        .chat-bubble-user { background-color: var(--chat-bubble-user-bg); color: var(--chat-bubble-user-text); }
        .chat-bubble-ai { background-color: var(--chat-bubble-ai-bg); color: var(--chat-bubble-ai-text); }
        html[dir="rtl"] .chat-bubble-user { border-bottom-right-radius: 0.375rem; }
        html[dir="rtl"] .chat-bubble-ai { border-bottom-left-radius: 0.375rem; }
        
        .voice-bubble-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        html[dir="rtl"] .message-container.self-end .voice-bubble-wrapper { flex-direction: row-reverse; }
        
        .transcript-container { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s ease-out, opacity 0.4s ease-out, margin-top 0.4s ease-out; }
        .transcript-container.expanded { max-height: 200px; opacity: 1; margin-top: 0.25rem; }
        .transcribed-text { font-size: 0.8rem; color: var(--input-text); background-color: var(--input-bg); border: 1px solid var(--input-border); padding: 0.5rem 1rem; border-radius: 1rem; max-width: 100%; word-wrap: break-word; text-align: right; }
        
        .toggle-transcript-btn {
            background-color: rgba(0,0,0,0.2);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
        }
        .toggle-transcript-btn svg {
            width: 18px;
            height: 18px;
            stroke: white;
            stroke-width: 2.5;
            transition: transform 0.3s ease-in-out;
        }
        .toggle-transcript-btn.rotated svg { transform: rotate(180deg); }

        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: currentColor; border-radius: 50%; display: inline-block; animation: typing-bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        .voice-reply-indicator { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 0.75rem !important; }
        .voice-reply-indicator svg { animation: voice-pulse 1.2s infinite ease-in-out; width: 24px; height: 24px; color: var(--chat-bubble-ai-text) }
        @keyframes voice-pulse { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.2); opacity: 1; } }

        #chat-input-container { position: fixed; left: 50%; transform: translateX(-50%); bottom: calc(var(--safe-area-bottom, 0px) + 10px); width: calc(100% - 1.5rem); max-width: 48rem; z-index: 15; }
        #chat-input-form { display: flex; align-items: flex-end; gap: 0.5rem; padding: 0.5rem; border-radius: 1.5rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); width: 100%; background-color: var(--card-bg); position: relative; overflow: visible; }
        
        #input-wrapper { flex-grow: 1; display: flex; align-items: center; background-color: var(--input-bg); border: 1px solid var(--input-border); border-radius: 1.25rem; min-height: 48px; transition: all 0.3s ease; overflow: hidden; position: relative; }
        
        #chat-input { flex-grow: 1; background-color: transparent; border: none; width: 100%; max-height: 150px; color: var(--input-text); resize: none; line-height: 1.5; overflow-y: hidden; transition: opacity 0.2s ease; }
        #chat-input:focus { outline: none; } #chat-input::placeholder { color: var(--input-placeholder); }

        .icon-btn { width: 2.75rem; height: 2.75rem; border-radius: 50%; color: var(--button-text-color); display: flex; align-items: center; justify-content: center; flex-shrink: 0; background-color: var(--brand-color); border: none; cursor:pointer; }
        [dir='rtl'] #chat-send-btn svg { transform: rotate(180deg); }
        [dir='ltr'] #chat-send-btn svg { transform: none; }

        #input-wrapper.recording { background-color: var(--brand-color); }
        #input-wrapper.recording.cancellation-warning { background-color: #ef4444; }
        #input-wrapper.recording #chat-input { opacity: 0; pointer-events: none; }
        #input-wrapper.recording .mic-btn { color: var(--button-text-color); }

        #recording-visuals { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #input-wrapper.recording #recording-visuals { opacity: 1; pointer-events: auto; }
        
        .mic-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 2.5rem; height: 2.5rem; border-radius: 50%; color: var(--brand-color); display: flex; align-items: center; justify-content: center; background-color: transparent; transition: color 0.3s ease; cursor: pointer; border: none; padding: 0; z-index: 5; }
        .mic-btn svg { width: 24px; height: 24px; }
        
        #recording-timer { position: absolute; top: 50%; transform: translateY(-50%); font-family: 'Inter', sans-serif; font-size: 1rem; font-weight: 500; color: white; }
        
        #waveform-container-middle { position: absolute; top: 0; height: 100%; }
        #waveform-canvas { width: 100%; height: 100%; }

        [dir="rtl"] .mic-btn { left: 4px; right: auto; }
        [dir="rtl"] #recording-timer { right: 16px; left: auto; }
        [dir="rtl"] #chat-input { padding: 12px 18px 12px 52px; }
        [dir="rtl"] #waveform-container-middle { left: 52px; right: 64px; }

        [dir="ltr"] .mic-btn { right: 4px; left: auto; }
        [dir="ltr"] #recording-timer { left: 16px; right: auto; }
        [dir="ltr"] #chat-input { padding: 12px 52px 12px 18px; }
        [dir="ltr"] #waveform-container-middle { left: 64px; right: 52px; }
        
        #delete-recording-btn { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); width: 3.25rem; height: 3.25rem; border-radius: 50%; background-color: rgba(239, 68, 68, 0.85); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.25s ease-out; backdrop-filter: blur(5px); margin-bottom: 0.75rem; cursor: pointer; border: none; z-index: 99; }
        #delete-recording-btn.visible { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px); }
        #delete-recording-btn:active, #delete-recording-btn.hovered { transform: translateX(-50%) translateY(-10px) scale(1.15); background-color: rgb(220, 38, 38); }

        .voice-bubble { padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.75rem; direction: ltr; overflow: hidden; }
        .voice-play-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; flex-shrink: 0; }
        .voice-play-btn svg { width: 28px; height: 28px; }
        .chat-bubble-user .voice-play-btn svg { fill: var(--chat-bubble-user-text); }
        .chat-bubble-ai .voice-play-btn svg { fill: var(--chat-bubble-ai-text); }
        .voice-play-btn:disabled svg { opacity: 0.5; }

        .waveform-container { flex-grow: 1; height: 35px; position: relative; }
        .waveform-visuals { position: absolute; top: 0; left: 0; width: 100%; height: 100%; -webkit-mask-size: 100% 100%; mask-size: 100% 100%; transition: background-color 0.1s; }
        
        .voice-duration { font-size: 0.8rem; opacity: 0.9; font-family: 'Inter', sans-serif; flex-shrink: 0; margin-left: 0.5rem; }
        .chat-bubble-user .voice-duration { color: var(--chat-bubble-user-text); }
        .chat-bubble-ai .voice-duration { color: var(--chat-bubble-ai-text); }
        
        .popup-hidden { display: none; }
        .popup-visible { display: flex; }

        #smart-icon-container {
            position: fixed;
            top: calc(var(--safe-area-top, 0px) + 75px);
            left: 0; right: 0; padding: 0 1.4rem;
            z-index: 25;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        
        html[dir="rtl"] #smart-icon-container {
            flex-direction: row-reverse;
        }

        #smart-icon-container button {
            width: 30px;
            height: 30px;
            padding: 3px;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        #smart-icon-container button svg {
            stroke: rgba(255, 255, 255, 0.6);
            stroke-width: 3;
        }

        #smart-icon-container button:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        #open-habal-levels-btn {
            cursor: default;
            pointer-events: none;
        }
       
        #voice-options-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.3); align-items: center; justify-content: center; z-index: 120; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        #voice-options-modal { padding: 1.5rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 360px; border: 1px solid var(--input-border); position: relative; background-color: var(--input-bg); text-align: center; }
        .modal-close-button { position: absolute; top: 0.75rem; left: 0.75rem; background: transparent; border: none; cursor: pointer; }
        #voice-options-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--brand-color); }
        #voice-options-list { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; max-height: 50vh; overflow-y: auto; padding-right: 10px; }
        .voice-option-label { display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; padding: 0.75rem; border: 1px solid var(--input-border); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; background-color: rgba(0,0,0,0.02); }
        .voice-option-label:hover { background-color: rgba(0,0,0,0.05); }
        .voice-option-radio-group { display: flex; align-items: center; gap: 0.75rem; flex-grow: 1; text-align: right; }
        .voice-option-label input[type="radio"] { accent-color: var(--brand-color); width: 1.15em; height: 1.15em; }
        .voice-option-label span { font-size: 1rem; font-weight: 500; }
        .voice-option-label input[type="radio"]:checked + span { font-weight: 700; color: var(--brand-color); }
        .voice-option-label:has(input[type="radio"]:checked) { border-color: var(--brand-color); box-shadow: 0 0 0 2px rgba(2, 121, 215, 0.2); }
        .voice-preview-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; color: var(--brand-color); display: flex; align-items: center; justify-content: center; }
        .voice-preview-btn .spinner { border-left-color: var(--brand-color); width: 20px; height: 20px; }
        .spinner { border: 3px solid rgba(0,0,0,0.1); width: 16px; height: 16px; border-radius: 50%; border-left-color: var(--brand-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #save-voice-options-btn { width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: bold; border: none; cursor: pointer; transition: opacity 0.2s; background-color: var(--brand-color); color: var(--button-text-color); }
        #save-voice-options-btn:hover { opacity: 0.9; }
    </style>
</head>
<body>

<video autoplay class="bg-video-element" id="lightBgVideo" loop muted playsinline></video>
<div class="overlay"></div>

<div class="custom-scrollbar" id="app-view-container">
     <div id="smart-icon-container">
        <button id="open-habal-levels-btn">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 20V15" stroke-width="3"/>
                <path d="M12 20V9" stroke-width="3"/>
                <path d="M18 20V4" stroke-width="3"/>
            </svg>
        </button>
        <button id="text-to-speech-btn">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
               <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke-linecap="round" stroke-linejoin="round"/>
               <path d="M15.54 8.46a5 5 0 0 1 0 7.07" stroke-linecap="round" stroke-linejoin="round"/>
               <path d="M19.07 4.93a10 10 0 0 1 0 14.14" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <header id="main-header">
        <button aria-label="Toggle Settings" class="header-icon" id="settings-toggle-btn">
            <svg fill="none" height="26" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="26" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l-.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
        <div id="main-title-wrapper"><div class="title-container"><h1><span class="font-rakkas">هَــبَــل</span><span class="font-inter"> AI</span></h1></div></div>
        <button aria-label="New Chat" class="header-icon" id="new-chat-btn">
            <svg fill="none" height="26" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="26" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                <line x1="12" x2="12" y1="7" y2="13"></line><line x1="9" x2="15" y1="10" y2="10"></line>
            </svg>
        </button>
    </header>
    <div id="chat-view"><div class="custom-scrollbar" id="chat-messages"></div></div>
</div>

<div id="chat-input-container">
    <div id="delete-recording-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
    </div>
    <form id="chat-input-form">
        <div id="input-wrapper">
            <textarea class="custom-scrollbar" id="chat-input" placeholder="حط هالرسالة تعيتك..." rows="1"></textarea>
            
            <div id="recording-visuals">
                <span id="recording-timer">0:00</span>
                <div id="waveform-container-middle">
                    <canvas id="waveform-canvas"></canvas>
                </div>
            </div>

            <button aria-label="Record Audio" class="mic-btn" id="mic-btn" type="button">
                <svg fill="currentColor" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/></svg>
            </button>
        </div>
        <button aria-label="Send Message" class="icon-btn" id="chat-send-btn" type="submit">
            <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
        </button>
    </form>
</div>

<div class="popup-hidden" id="voice-options-modal-overlay">
    <div id="voice-options-modal">
        <button aria-label="Close" class="modal-close-button" id="close-voice-options-modal-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" height="20" width="20" viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5">
                <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <h3 id="voice-options-title">الصوت</h3>
        <div class="custom-scrollbar" id="voice-options-list">
        </div>
        <button id="save-voice-options-btn">حفظ</button>
    </div>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', () => {
    const dom = { chatMessages: document.getElementById('chat-messages'), chatInputForm: document.getElementById('chat-input-form'), chatInput: document.getElementById('chat-input'), chatSendBtn: document.getElementById('chat-send-btn'), micBtn: document.getElementById('mic-btn'), inputWrapper: document.getElementById('input-wrapper'), recordingVisuals: document.getElementById('recording-visuals'), recordingTimer: document.getElementById('recording-timer'), waveformCanvas: document.getElementById('waveform-canvas'), deleteRecordingBtn: document.getElementById('delete-recording-btn'), lightBgVideo: document.getElementById('lightBgVideo'), textToSpeechBtn: document.getElementById('text-to-speech-btn'), voiceOptionsModalOverlay: document.getElementById('voice-options-modal-overlay'), voiceOptionsList: document.getElementById('voice-options-list'), closeVoiceOptionsModalBtn: document.getElementById('close-voice-options-modal-btn'), saveVoiceOptionsBtn: document.getElementById('save-voice-options-btn') };
    let mediaRecorder, audioStream, audioChunks = [], audioContext, analyser, waveformData, animationFrameId;
    let isRecording = false, recordingMode = null, recordingStartTime, timerInterval, longPressTimer;
    let wasCancelled = false, currentConversation = [], isPlayingPreview = false, previewAudio;
    const API_KEY = "AIzaSyAMDuSsJxG2PDabvs8gm1-gCdjRbdNMNvc";
    const canvasCtx = dom.waveformCanvas.getContext('2d');
    const LONG_PRESS_DURATION = 250;
    
    const TONE_URLS = {
        start: 'https://dl.dropbox.com/scl/fi/ki3jxogrzck2f4oq0ouix/start_tone.wav?rlkey=tjw5vpk3qhgt0k1881pq66qky&dl=1',
        cancel: 'https://dl.dropbox.com/scl/fi/u07r8izligr4xm2fvwk2k/cancel_tone.wav?rlkey=vn038frwre44ylvgsgwwq0x1r&dl=1',
        send: 'https://dl.dropbox.com/scl/fi/kted3ieclfgdqg024beq7/send_tone.wav?rlkey=kyy97ur3x1pqzjy4nul7hgyny&dl=1'
    };
    const loadedTones = {};

    function preloadTones() {
        for (const key in TONE_URLS) {
            loadedTones[key] = new Audio(TONE_URLS[key]);
            loadedTones[key].preload = 'auto';
            loadedTones[key].load();
        }
    }

    function playSound(toneName) {
        const audio = loadedTones[toneName];
        if (audio) {
            audio.currentTime = 0;
            audio.play().catch(error => console.error(`Error playing ${toneName} tone:`, error));
        }
    }

    const voiceProfiles = [
        { name: 'سارة', value: 'Aoede', previewAr: 'https://dl.dropbox.com/scl/fi/wooxx635fpdjuy3yye9kt/sara.ar.wav?rlkey=gvi0189c7z3v35wktnxs0oqo8&dl=0', previewEn: 'https://dl.dropbox.com/scl/fi/2uj2uxa2ufxca5ygpb920/sara.en.wav?rlkey=brhkb25owr827eo9zyjow41d5&dl=0' },
        { name: 'جسيكا', value: 'Laomedeia', previewAr: 'https://dl.dropbox.com/scl/fi/rbwc01fpwdnjuzp68r71d/jasika.ar.wav?rlkey=214d3kgmn9cjqvpwh8fo9jasf&dl=0', previewEn: 'https://dl.dropbox.com/scl/fi/ghpovtcv65evbqoem0s3r/Jessica.en.wav?rlkey=9mbcn5gxdub6z0zcxvw2fjboa&dl=0' },
        { name: 'ادم', value: 'Puck', previewAr: 'https://dl.dropbox.com/scl/fi/dbe9epvmxmoyomhq3hwi6/adam.ar.wav?rlkey=muk6g4rhobzrl8tzfk4e15xlc&dl=0', previewEn: 'https://dl.dropbox.com/scl/fi/00xrcuo6vkqyoyc7dk0xl/Adam.en.wav?rlkey=u7vb4tqd3v63lq2jn6w6oywu8&dl=0' },
        { name: 'توماس', value: 'Fenrir', previewAr: 'https://dl.dropbox.com/scl/fi/r9wqrbegn4boqw2mnxusg/thomas.ar.wav?rlkey=s51kp46tnw3tl0oxqbsxybuq8&dl=0', previewEn: 'https://dl.dropbox.com/scl/fi/vo28h7nspwa9qz1wbkddw/thomas.en.wav?rlkey=73fpr1oqtglovwql06ibaoiyi&dl=0' }
    ];

    function populateVoiceOptions() { dom.voiceOptionsList.innerHTML = ''; const savedVoice = localStorage.getItem('selectedTtsVoice') || 'Aoede'; voiceProfiles.forEach(profile => { const isChecked = profile.value === savedVoice; const label = document.createElement('label'); label.className = 'voice-option-label'; label.innerHTML = `<div class="voice-option-radio-group"><input type="radio" name="voice" value="${profile.value}" ${isChecked ? 'checked' : ''}><span>${profile.name}</span></div><button class="voice-preview-btn" data-voice="${profile.value}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></button>`; dom.voiceOptionsList.appendChild(label); }); document.querySelectorAll('.voice-preview-btn').forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); previewVoice(e.currentTarget); })); }
    async function sendApiRequest(endpoint, payload, retries = 3, delay = 1000) { try { const url = `https://generativelanguage.googleapis.com/v1beta/models/${endpoint}?key=${API_KEY}`; const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { const errorText = await response.text(); if (response.status === 429 || errorText.includes('overloaded')) { throw new Error('overloaded'); } const errorData = JSON.parse(errorText); throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`); } return await response.json(); } catch (error) { if (error.message === 'overloaded' && retries > 0) { console.warn(`Model is overloaded. Retrying in ${delay / 1000}s... (${retries} retries left)`); await new Promise(res => setTimeout(res, delay)); return sendApiRequest(endpoint, payload, retries - 1, delay * 2); } throw error; } }
    function blobToBase64(blob) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => { const base64data = reader.result.split(',')[1]; resolve(base64data); }; reader.onerror = reject; reader.readAsDataURL(blob); }); }
    function base64ToArrayBuffer(base64) { const binaryString = window.atob(base64); const len = binaryString.length; const bytes = new Uint8Array(len); for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); } return bytes.buffer; }
    function pcmToWav(pcmData, sampleRate) { const numChannels = 1, bitsPerSample = 16, blockAlign = (numChannels * bitsPerSample) / 8, byteRate = sampleRate * blockAlign, dataSize = pcmData.length * (bitsPerSample / 8), buffer = new ArrayBuffer(44 + dataSize), view = new DataView(buffer); writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true); writeString(view, 36, 'data'); view.setUint32(40, dataSize, true); for (let i = 0; i < pcmData.length; i++) { view.setInt16(44 + i * 2, pcmData[i], true); } return new Blob([view], { type: 'audio/wav' }); }
    function writeString(view, offset, string) { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } }
    function showPopup(el) { if (el) { el.classList.remove('popup-hidden'); el.classList.add('popup-visible'); } }
    function hidePopup(el) { if (el) { el.classList.remove('popup-visible'); el.classList.add('popup-hidden'); } }
    function setupPopupListeners() { dom.textToSpeechBtn.addEventListener('click', () => showPopup(dom.voiceOptionsModalOverlay)); dom.closeVoiceOptionsModalBtn.addEventListener('click', () => hidePopup(dom.voiceOptionsModalOverlay)); dom.saveVoiceOptionsBtn.addEventListener('click', () => { const selected = dom.voiceOptionsList.querySelector('input[name="voice"]:checked'); if (selected) localStorage.setItem('selectedTtsVoice', selected.value); hidePopup(dom.voiceOptionsModalOverlay); }); dom.voiceOptionsModalOverlay.addEventListener('click', e => { if (e.target === dom.voiceOptionsModalOverlay) hidePopup(dom.voiceOptionsModalOverlay); }); }
    
    async function setupAudio() { 
        try { 
            if (audioStream) audioStream.getTracks().forEach(track => track.stop()); 
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true }); 
            mediaRecorder = new MediaRecorder(audioStream); 
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); 
            const source = audioContext.createMediaStreamSource(audioStream); 
            analyser = audioContext.createAnalyser(); 
            analyser.fftSize = 256; 
            source.connect(analyser); 
            waveformData = new Uint8Array(analyser.frequencyBinCount); 
            
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); }; 
            
            mediaRecorder.onstop = async () => {
                if (wasCancelled || audioChunks.length === 0) {
                    audioChunks = [];
                    return;
                }
                playSound('send'); // Play sound on successful send
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                handleAiResponse(null, audioBlob);
                audioChunks = [];
            }; 
            return true; 
        } catch (err) { 
            console.error("Mic access error:", err); 
            dom.chatInput.placeholder = "لم يتم السماح بالوصول للميكروفون"; 
            setTimeout(() => { dom.chatInput.placeholder = "حط هالرسالة تعيتك..."; }, 3000); 
            return false; 
        } 
    }

    function drawScrollingWaveform() { animationFrameId = requestAnimationFrame(drawScrollingWaveform); analyser.getByteFrequencyData(waveformData); const scrollSpeed = 2, width = dom.waveformCanvas.width, height = dom.waveformCanvas.height; canvasCtx.globalCompositeOperation = 'copy'; const avg = waveformData.reduce((a, b) => a + b, 0) / waveformData.length; const barHeight = (avg / 128.0) * height * 0.9; const finalBarHeight = Math.max(2, barHeight > 2 ? barHeight : 2); canvasCtx.fillStyle = 'white'; if (document.documentElement.dir === 'rtl') { canvasCtx.drawImage(dom.waveformCanvas, scrollSpeed, 0); canvasCtx.globalCompositeOperation = 'source-over'; canvasCtx.fillRect(0, (height - finalBarHeight) / 2, scrollSpeed, finalBarHeight); } else { canvasCtx.drawImage(dom.waveformCanvas, -scrollSpeed, 0); canvasCtx.globalCompositeOperation = 'source-over'; canvasCtx.fillRect(width - scrollSpeed, (height - finalBarHeight) / 2, scrollSpeed, finalBarHeight); } }
    
    function startRecording() {
        if (isRecording) return;
        wasCancelled = false;
        setupAudio().then(success => { if (!success) { recordingMode = null; return; } isRecording = true; audioChunks = []; mediaRecorder.start(); recordingStartTime = Date.now(); dom.inputWrapper.classList.add('recording'); dom.deleteRecordingBtn.classList.add('visible'); updateTimer(); timerInterval = setInterval(updateTimer, 1000); requestAnimationFrame(() => { dom.waveformCanvas.width = dom.waveformCanvas.offsetWidth; dom.waveformCanvas.height = dom.waveformCanvas.offsetHeight; canvasCtx.clearRect(0, 0, dom.waveformCanvas.width, dom.waveformCanvas.height); drawScrollingWaveform(); }); });
    }
    
    function stopRecording(cancelled = false) {
        if (!isRecording) return;
        if (cancelled) playSound('cancel');
        
        wasCancelled = cancelled;
        if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
        if (audioStream) audioStream.getTracks().forEach(track => track.stop());
        isRecording = false; recordingMode = null; clearInterval(timerInterval); cancelAnimationFrame(animationFrameId);
        dom.inputWrapper.classList.remove('recording', 'cancellation-warning'); dom.deleteRecordingBtn.classList.remove('visible', 'hovered'); dom.recordingTimer.textContent = "0:00";
    }

    function updateTimer() { const seconds = Math.floor((Date.now() - recordingStartTime) / 1000); dom.recordingTimer.textContent = `${Math.floor(seconds / 60)}:${(seconds % 60).toString().padStart(2, '0')}`; }
    
    const handleMicPress = e => {
        e.preventDefault();
        if (isRecording || longPressTimer) return;
        playSound('start'); 
        longPressTimer = setTimeout(() => {
            longPressTimer = null;
            recordingMode = 'hold';
            startRecording();
        }, LONG_PRESS_DURATION);
    };
    
    const handleMicRelease = e => {
        e.preventDefault();
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
            recordingMode = 'tap';
            startRecording();
        } else if (isRecording && recordingMode === 'hold') {
            const touchOrMouse = e.changedTouches ? e.changedTouches[0] : e;
            const elemUnder = document.elementFromPoint(touchOrMouse.clientX, touchOrMouse.clientY);
            const isCancelled = dom.deleteRecordingBtn.contains(elemUnder);
            setTimeout(() => stopRecording(isCancelled), 50);
        }
    };
    
    function createVoiceBubble(role, audioUrl, duration) { const bubble = document.createElement('div'); bubble.className = `chat-bubble chat-bubble-${role} voice-bubble`; const audio = new Audio(audioUrl); const durationFormatted = `${Math.floor(duration / 60)}:${Math.round(duration % 60).toString().padStart(2, '0')}`; const playIconHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.647c1.295.748 1.295 2.539 0 3.286L7.279 20.99c-1.25.72-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" /></svg>`; const pauseIconHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 0-.75.75v12a.75.75 0 0 0 .75.75h.75a.75.75 0 0 0 .75-.75V6a.75.75 0 0 0-.75-.75H6.75Zm8.25 0a.75.75 0 0 0-.75.75v12a.75.75 0 0 0 .75.75h.75a.75.75 0 0 0 .75-.75V6a.75.75 0 0 0-.75-.75h-.75Z" clip-rule="evenodd" /></svg>`; bubble.innerHTML = `<button class="voice-play-btn">${playIconHTML}</button><div class="waveform-container"><div class="waveform-visuals"></div></div><span class="voice-duration">${durationFormatted}</span>`; const playPauseBtn = bubble.querySelector('.voice-play-btn'), waveformVisuals = bubble.querySelector('.waveform-visuals'); const waveColor = (role === 'user') ? 'white' : 'black', waveBg = (role === 'user') ? 'rgba(255, 255, 255, 0.4)' : '#D1D5DB'; waveformVisuals.style.backgroundColor = waveColor; audio.onplay = () => { playPauseBtn.innerHTML = pauseIconHTML; waveformVisuals.style.backgroundColor = waveBg; }; audio.onpause = () => { playPauseBtn.innerHTML = playIconHTML; waveformVisuals.style.backgroundColor = waveColor; waveformVisuals.style.backgroundImage = 'none'; }; audio.onended = () => audio.currentTime = 0; audio.ontimeupdate = () => { const progress = (audio.currentTime / audio.duration) * 100; waveformVisuals.style.backgroundImage = `linear-gradient(to right, ${waveColor} ${progress}%, transparent ${progress}%)`; }; playPauseBtn.onclick = () => { audio.paused ? audio.play() : audio.pause(); }; const baseWidth = 120, maxWidth = 320, widthPerSecond = 8; bubble.style.width = `${Math.min(maxWidth, baseWidth + duration * widthPerSecond)}px`; requestAnimationFrame(() => { const maskCanvas = document.createElement('canvas'), wfContainer = bubble.querySelector('.waveform-container'); if (!wfContainer) return; maskCanvas.width = wfContainer.offsetWidth; maskCanvas.height = wfContainer.offsetHeight; const ctx = maskCanvas.getContext('2d'), numBars = Math.max(15, Math.min(80, Math.floor(duration * 5))); const barWidth = 2, barGap = 2, centerY = maskCanvas.height / 2; ctx.fillStyle = '#000'; for (let i = 0; i < numBars; i++) { const sineFactor = Math.sin((i / numBars) * Math.PI); const barHeight = maskCanvas.height * 0.9 * (0.3 + Math.random() * 0.7) * sineFactor; ctx.fillRect(i * (barWidth + barGap), centerY - barHeight / 2, barWidth, Math.max(2, barHeight)); } const maskDataUrl = maskCanvas.toDataURL(); waveformVisuals.style.webkitMaskImage = `url(${maskDataUrl})`; waveformVisuals.style.maskImage = `url(${maskDataUrl})`; }); return bubble; }
    function createTextBubble(role, text) { const bubble = document.createElement('div'); bubble.className = `chat-bubble chat-bubble-${role}`; bubble.textContent = text; return bubble; }
    function constructPrompt(messageText) { const history = currentConversation.map(m => `${m.role === 'user' ? 'المستخدم' : 'AI'}: ${m.text}`).join('\n'); return `أجب على الرسالة الجديدة بناءً على سجل المحادثة هذا:\n${history}\n\nالرسالة الجديدة من المستخدم: ${messageText}`; }
    function createDummyVoiceBubble() { const bubble = document.createElement('div'); bubble.className = `chat-bubble chat-bubble-ai voice-bubble`; const playIconHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.647c1.295.748 1.295 2.539 0 3.286L7.279 20.99c-1.25.72-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" /></svg>`; bubble.innerHTML = `<button class="voice-play-btn" disabled>${playIconHTML}</button><div class="waveform-container"><div class="waveform-visuals" style="background-color: black; -webkit-mask-image: none; mask-image: none;"></div></div><span class="voice-duration">0:00</span>`; bubble.style.width = '120px'; return bubble; }

    async function handleAiResponse(text, audioBlob) {
        const isVoiceQuery = !!audioBlob;
        let indicator, aiResponseText = null, ttsData = null, finalError = null;
        
        const userMessageContainer = document.createElement('div');
        userMessageContainer.className = `message-container self-end`;
        dom.chatMessages.appendChild(userMessageContainer);
        let userMessageText = text;

        if (isVoiceQuery) {
            const audioUrl = URL.createObjectURL(audioBlob);
            const duration = await getAudioDuration(audioBlob);
            const transcriptContainer = document.createElement('div');
            transcriptContainer.className = 'transcript-container';
            const voiceBubbleWrapper = document.createElement('div');
            voiceBubbleWrapper.className = 'voice-bubble-wrapper';
            voiceBubbleWrapper.appendChild(createToggleTranscriptButton(transcriptContainer));
            voiceBubbleWrapper.appendChild(createVoiceBubble('user', audioUrl, duration));
            userMessageContainer.appendChild(voiceBubbleWrapper);
            userMessageContainer.appendChild(transcriptContainer);
            indicator = showVoiceReplyIndicator();
        } else {
            userMessageContainer.appendChild(createTextBubble('user', text));
            indicator = showTypingIndicator();
        }
        scrollToBottom();

        try {
            if (isVoiceQuery) {
                const sttResult = await sendApiRequest('gemini-2.5-flash-preview-05-20:generateContent', { contents: [{ parts: [ { text: "الرجاء تحويل هذا المقطع الصوتي إلى نص:" }, { inlineData: { mimeType: "audio/webm", data: await blobToBase64(audioBlob) } } ] }] });
                userMessageText = sttResult.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!userMessageText) throw new Error("فشل تحويل الصوت إلى نص.");
                const transcriptContainer = userMessageContainer.querySelector('.transcript-container');
                if(transcriptContainer) transcriptContainer.innerHTML = `<div class="transcribed-text">${userMessageText}</div>`;
            }
            currentConversation.push({ role: 'user', text: userMessageText });
            const aiResult = await sendApiRequest('gemini-2.5-flash-preview-05-20:generateContent', { contents: [{ parts: [{ text: constructPrompt(userMessageText) }] }] });
            aiResponseText = aiResult.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!aiResponseText) throw new Error("لم يتمكن الذكاء الاصطناعي من إنشاء رد نصي.");
            currentConversation.push({ role: 'model', text: aiResponseText });

            if (isVoiceQuery) {
                const ttsPayload = { contents: [{ parts: [{ text: aiResponseText }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: localStorage.getItem('selectedTtsVoice') || 'Aoede' } } } } };
                const ttsResult = await sendApiRequest('gemini-2.5-flash-preview-tts:generateContent', ttsPayload);
                const part = ttsResult?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (!audioData || !mimeType) throw new Error("بيانات الصوت المستلمة غير صالحة.");
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                if (!sampleRateMatch) throw new Error("لم يتم العثور على معدل العينة.");
                const sampleRate = parseInt(sampleRateMatch[1], 10);
                const pcm16 = new Int16Array(base64ToArrayBuffer(audioData));
                const wavBlob = pcmToWav(pcm16, sampleRate);
                ttsData = { url: URL.createObjectURL(wavBlob), duration: await getAudioDuration(wavBlob) };
            }
        } catch (error) {
            console.error("An error occurred during AI processing:", error);
            finalError = error;
        }
        
        indicator.remove();
        const aiMessageContainer = document.createElement('div');
        aiMessageContainer.className = 'message-container self-start';
        
        if (isVoiceQuery) {
            let transcriptText;
            const transcriptContainer = document.createElement('div');
            transcriptContainer.className = 'transcript-container';
            const aiBubbleWrapper = document.createElement('div');
            aiBubbleWrapper.className = 'voice-bubble-wrapper';
            
            if (ttsData) {
                aiBubbleWrapper.appendChild(createVoiceBubble('ai', ttsData.url, ttsData.duration));
                transcriptText = aiResponseText;
            } else {
                aiBubbleWrapper.appendChild(createDummyVoiceBubble());
                transcriptText = aiResponseText || (finalError ? finalError.message : "حدث خطأ غير معروف.");
            }
            aiBubbleWrapper.appendChild(createToggleTranscriptButton(transcriptContainer));
            transcriptContainer.innerHTML = `<div class="transcribed-text">${transcriptText}</div>`;
            aiMessageContainer.appendChild(aiBubbleWrapper);
            aiMessageContainer.appendChild(transcriptContainer);
        } else {
            aiMessageContainer.appendChild(createTextBubble('ai', aiResponseText || (finalError ? finalError.message : "عذراً، حدث خطأ ما.")));
        }
        
        dom.chatMessages.appendChild(aiMessageContainer);
        scrollToBottom();
    }
    
    function createToggleTranscriptButton(transcriptContainer) { const button = document.createElement('button'); button.className = 'toggle-transcript-btn'; button.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`; button.addEventListener('click', () => { transcriptContainer.classList.toggle('expanded'); button.classList.toggle('rotated'); setTimeout(() => scrollToBottom(), 50); }); return button; }
    
    async function previewVoice(button) {
        if (isPlayingPreview) {
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
            }
            isPlayingPreview = false;
            document.querySelectorAll('.voice-preview-btn').forEach(btn => {
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
                btn.disabled = false;
            });
            return;
        }

        isPlayingPreview = true;
        const voiceValue = button.dataset.voice;
        const profile = voiceProfiles.find(p => p.value === voiceValue);
        if (!profile) {
            console.error("Voice profile not found:", voiceValue);
            isPlayingPreview = false;
            return;
        }

        const isRtl = document.documentElement.dir === 'rtl';
        const audioUrl = isRtl ? profile.previewAr : profile.previewEn;
        
        const originalContent = button.innerHTML;
        button.innerHTML = `<div class="spinner"></div>`;
        button.disabled = true;

        document.querySelectorAll('.voice-preview-btn').forEach(btn => {
            if (btn !== button) btn.disabled = true;
        });

        previewAudio = new Audio(audioUrl);
        const playIcon = originalContent;
        const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`;

        const resetUI = () => {
            isPlayingPreview = false;
            button.innerHTML = playIcon;
            document.querySelectorAll('.voice-preview-btn').forEach(btn => btn.disabled = false);
        };

        previewAudio.addEventListener('canplaythrough', () => {
            button.innerHTML = pauseIcon;
            button.disabled = false;
            previewAudio.play().catch(resetUI);
        });
        
        previewAudio.addEventListener('ended', resetUI);
        previewAudio.addEventListener('error', () => {
            console.error("Error loading or playing audio preview.");
            resetUI();
        });
    }

    function getAudioDuration(blob) { return new Promise(resolve => { const tempAudio = document.createElement('audio'); tempAudio.src = URL.createObjectURL(blob); tempAudio.addEventListener('loadedmetadata', () => { resolve(tempAudio.duration); URL.revokeObjectURL(tempAudio.src); }); tempAudio.addEventListener('error', () => resolve(0)); }); }
    function scrollToBottom() { dom.chatMessages.scrollTop = dom.chatMessages.scrollHeight; }
    function showTypingIndicator() { const bubble = document.createElement('div'); bubble.className = 'chat-bubble self-start chat-bubble-ai typing-indicator'; bubble.innerHTML = `<span></span><span></span><span></span>`; const wrapper = document.createElement('div'); wrapper.className = 'message-container self-start'; wrapper.appendChild(bubble); dom.chatMessages.appendChild(wrapper); scrollToBottom(); return wrapper; }
    function showVoiceReplyIndicator() { const bubble = document.createElement('div'); bubble.className = 'chat-bubble self-start chat-bubble-ai voice-reply-indicator'; bubble.innerHTML = `<svg fill="currentColor" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/></svg>`; const wrapper = document.createElement('div'); wrapper.className = 'message-container self-start'; wrapper.appendChild(bubble); dom.chatMessages.appendChild(wrapper); scrollToBottom(); return wrapper; }
    function setupRecordingInteraction() { dom.deleteRecordingBtn.addEventListener('mouseenter', () => { if (isRecording) dom.inputWrapper.classList.add('cancellation-warning'); }); dom.deleteRecordingBtn.addEventListener('mouseleave', () => { if (isRecording) dom.inputWrapper.classList.remove('cancellation-warning'); }); let isTouchingDelete = false; const handleTouchMove = e => { if (!isRecording) return; const touch = e.touches[0]; if (!touch) return; const isOverDelete = dom.deleteRecordingBtn.contains(document.elementFromPoint(touch.clientX, touch.clientY)); if (isOverDelete && !isTouchingDelete) { isTouchingDelete = true; dom.inputWrapper.classList.add('cancellation-warning'); } else if (!isOverDelete && isTouchingDelete) { isTouchingDelete = false; dom.inputWrapper.classList.remove('cancellation-warning'); } }; const handleTouchEnd = () => { if (isTouchingDelete) { isTouchingDelete = false; dom.inputWrapper.classList.remove('cancellation-warning'); } }; window.addEventListener('touchmove', handleTouchMove); window.addEventListener('touchend', handleTouchEnd); window.addEventListener('touchcancel', handleTouchEnd); }

    function initializeApp() {
        preloadTones();

        dom.lightBgVideo.src = 'https://dl.dropbox.com/scl/fi/7ftqtfz5erltm6v3l91a8/light_video.mp4?rlkey=4una3oaymvmdthpc7ra7xapxr&st=1f0ners0&dl=0';
        dom.lightBgVideo.play().catch(e => console.error("Video autoplay failed:", e));
        dom.lightBgVideo.classList.add('video-visible');
        
        setupRecordingInteraction();
        populateVoiceOptions();
        setupPopupListeners();

        dom.micBtn.addEventListener('mousedown', handleMicPress);
        dom.micBtn.addEventListener('mouseup', handleMicRelease);
        dom.micBtn.addEventListener('touchstart', handleMicPress, { passive: false });
        dom.micBtn.addEventListener('touchend', handleMicRelease);
        dom.deleteRecordingBtn.addEventListener('click', () => stopRecording(true));

        dom.chatInputForm.addEventListener('submit', e => {
            e.preventDefault();
            const text = dom.chatInput.value.trim();
            if (isRecording && recordingMode === 'tap') {
                setTimeout(() => stopRecording(), 50);
            } else if (!isRecording && text) {
                dom.chatInput.value = '';
                dom.chatInput.style.height = 'auto';
                handleAiResponse(text, null);
            }
        });

        dom.chatInput.addEventListener('input', () => {
            dom.chatInput.style.height = 'auto';
            dom.chatInput.style.height = (dom.chatInput.scrollHeight) + 'px';
        });
    }

    initializeApp();
});
</script>

</body>
</html>



